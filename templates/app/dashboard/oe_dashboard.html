{% load static %}

 <!-- Start::row-1 -->
 <div class="row">
    <div class="col-xxl-12 col-md-12 col-lg-12">
        
        <!-- Welcome Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card custom-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-custom-gradient rounded-circle shadow-gradient">
                                    <i class="fe fe-user fs-16 text-white"></i>
                                </span>
                            </div>
                            <div>
                                <h4 class="mb-1 text-gradient">Welcome back, {{ request.user.get_full_name|default:request.user.email }}!</h4>
                                <p class="mb-0 text-muted">Here's what's happening in your system today.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row">
            <!-- Total Users -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'users:user_profile_list' %}">
                    <div class="card custom-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-lg bg-custom-gradient rounded-circle shadow-gradient">
                                        <i class="fe fe-users fs-16 text-white"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h4 class="mb-1 fw-semibold text-gradient">{{ total_users }}</h4>
                                    <p class="mb-0 text-muted">Total Users</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success-transparent">{{ new_users_this_month }} new this month</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Total Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}">
                    <div class="card custom-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-warning-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-warning"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ total_requests }}</h4>
                                <p class="mb-0 text-muted">Total Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning-transparent">{{ pending_requests }} pending</span>
                            </div>
                        </div>
                    </div>
                    </div>
                </a>
            </div>

            <!-- Approved Requests Card: Use director_approved_count for director -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}?status=approved">
                    <div class="card custom-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-lg bg-success-transparent rounded-circle">
                                        <i class="fe fe-check-circle fs-16 text-success"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h4 class="mb-1 fw-semibold">
                                        {% if request.user.usertype == 'director' %}
                                            {{ director_approved_count|default:0 }}
                                        {% else %}
                                            {{ approved_requests }}
                                        {% endif %}
                                    </h4>
                                    <p class="mb-0 text-muted">Approved</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success-transparent">{{ request_completion_rate }}% completion</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Rejected Requests Card: Use director_rejected_count for director -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}?status=rejected">
                    <div class="card custom-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-lg bg-danger-transparent rounded-circle">
                                        <i class="fe fe-x-circle fs-16 text-danger"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <h4 class="mb-1 fw-semibold">
                                        {% if request.user.usertype == 'director' %}
                                            {{ director_rejected_count|default:0 }}
                                        {% else %}
                                            {{ rejected_requests }}
                                        {% endif %}
                                    </h4>
                                    <p class="mb-0 text-muted">Rejected</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-danger-transparent">{{ avg_processing_time }} days avg</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
        </div>

        <!-- Assigned Requests Table -->
        <div class="row mb-4 m-0 p-0">
            <div class="col-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Assigned Requests</h3>
                        <div class="card-options">
                            <a href="{% url 'masters:request_submission_list' %}" class="btn btn-sm btn-primary gradient-hover">View All</a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in recent_assigned_requests %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm bg-light rounded-circle me-2">
                                                    <i class="fe fe-file-text fs-12"></i>
                                                </span>
                                                <div>
                                                    <h6 class="mb-0 fs-14">{{ request.title|truncatechars:30 }}</h6>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if request.dashboard_status == 'processing' %}
                                                <span class="badge bg-primary text-white">Processing</span>
                                            {% else %}
                                                <span class="badge bg-warning text-white">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ request.created|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <a href="{{ request.get_absolute_url }}" class="btn btn-sm btn-outline-primary">View</a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <div class="text-center">
                                                <i class="fe fe-file-text fs-48 text-muted mb-3"></i>
                                                <h6>No assigned requests</h6>
                                                <p class="text-muted">You have no requests assigned to you.</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="row p-0 m-0">
            <!-- Monthly Trends Chart -->
            <div class="col-xl-8 col-lg-8 col-md-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Monthly Trends</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Request Submissions</h6>
                                <div style="height:300px;">
                                    <canvas id="requestsChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">User Registrations</h6>
                                <div style="height:300px;">
                                    <canvas id="usersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="col-xl-4 col-lg-4 col-md-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Request Status Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div style="height:300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="mt-3">
                            {% for status in status_distribution %}
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="text-muted">{{ status.current_status|title }}</span>
                                <span class="fw-semibold">{{ status.count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity and User Distribution -->
        <div class="row m-0 p-0">
            <!-- Recent Requests -->
            <div class="col-xl-6 col-lg-6 col-md-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Requests</h3>
                        <div class="card-options">
                            <a href="{% url 'masters:request_submission_list' %}" class="btn btn-sm btn-primary gradient-hover">View All</a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in recent_requests %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm bg-light rounded-circle me-2">
                                                    <i class="fe fe-file-text fs-12"></i>
                                                </span>
                                                <div>
                                                    <h6 class="mb-0 fs-14">{{ request.title|truncatechars:30 }}</h6>
                                                    <small class="text-muted">{{ request.collage.first_name }} {{ request.collage.last_name }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% with request.status_history.first as latest_status %}
                                                {% if latest_status.status == 'approved' and request.current_usertype == 'OE' %}
                                                    <span class="badge bg-success-transparent">Approved</span>
                                                {% elif latest_status.status == 'rejected' and request.current_usertype == 'OE' %}
                                                    <span class="badge bg-danger-transparent">Rejected</span>
                                                {% else %}
                                                    <span class="badge bg-warning-transparent">Pending</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ request.created|date:"M d, Y" }}</small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">No recent requests</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Type Distribution -->
            <div class="col-xl-6 col-lg-6 col-md-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">User Type Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div style="height:300px;">
                                    <canvas id="userTypeChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="user-type-list">
                                    {% for usertype in usertype_distribution %}
                                    <div class="user-type-item">
                                        <div class="user-type-info">
                                            <div class="user-type-icon">
                                                {% if usertype.usertype == "director" %}
                                                    <i class="fe fe-award text-primary"></i>
                                                {% elif usertype.usertype == "CRO" %}
                                                    <i class="fe fe-users text-success"></i>
                                                {% elif usertype.usertype == "PRO" %}
                                                    <i class="fe fe-message-circle text-info"></i>
                                                {% elif usertype.usertype == "CAO" %}
                                                    <i class="fe fe-book-open text-warning"></i>
                                                {% elif usertype.usertype == "AC" %}
                                                    <i class="fe fe-settings text-purple"></i>
                                                {% elif usertype.usertype == "AA" %}
                                                    <i class="fe fe-user-plus text-secondary"></i>
                                                {% elif usertype.usertype == "FO" %}
                                                    <i class="fe fe-dollar-sign text-danger"></i>
                                                {% elif usertype.usertype == "Collage" %}
                                                    <i class="fe fe-home text-teal"></i>
                                                {% else %}
                                                    <i class="fe fe-user text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div class="user-type-details">
                                                <h6 class="mb-0">
                                                    {% if usertype.usertype == "CRO" %}
                                                        Chief Relation Officer
                                                    {% elif usertype.usertype == "PRO" %}
                                                        Public Relation Officer
                                                    {% elif usertype.usertype == "CAO" %}
                                                        Chief Academic Officer
                                                    {% elif usertype.usertype == "director" %}
                                                        Director
                                                    {% elif usertype.usertype == "AC" %}
                                                        Admin Coordinator
                                                    {% elif usertype.usertype == "AA" %}
                                                        Assistant Administrator
                                                    {% elif usertype.usertype == "FO" %}
                                                        Finance Officer
                                                    {% elif usertype.usertype == "Collage" %}
                                                        College
                                                    {% else %}
                                                        {{ usertype.usertype|title }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">{{ usertype.count }} users</small>
                                            </div>
                                        </div>
                                        <div class="user-type-percentage">
                                            <span class="percentage-badge">{{ usertype.count|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Status Changes -->
        <div class="row m-0 p-0">
            <div class="col-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Status Changes</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="recentStatusChangesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Request</th>
                                        <th>User</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for change in recent_status_changes %}
                                    <tr class="recent-status-row{% if forloop.counter > 5 %} d-none{% endif %}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm bg-light rounded-circle me-2">
                                                    <i class="fe fe-file-text fs-12"></i>
                                                </span>
                                                <div>
                                                    <h6 class="mb-0 fs-14">{{ change.submission.title|truncatechars:30 }}</h6>
                                                    <small class="text-muted">{{ change.usertype }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if change.user %}
                                                {{ change.user.first_name }}
                                                
                                                {% if change.user.last_name %}
                                                    {{ change.user.last_name }}
                                                {% endif %}

                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if change.status == 'approved' %}
                                                <span class="badge bg-success-transparent">Approved</span>
                                            {% elif change.status == 'rejected' %}
                                                <span class="badge bg-danger-transparent">Rejected</span>
                                            {% else %}
                                                <span class="badge bg-warning-transparent">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ change.date|date:"M d, Y H:i" }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ change.remark|safe|truncatechars:50|default:"-" }}</small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">No recent status changes</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if recent_status_changes|length > 5 %}
                        <div class="text-center py-3">
                            <button id="viewMoreStatusBtn" class="btn btn-outline-primary btn-sm">Show More</button>
                            <button id="showLessStatusBtn" class="btn btn-outline-secondary btn-sm d-none">Show Less</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>


{% block javascript %}
<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Requests Chart
    var requestsChartElem = document.getElementById('requestsChart');
    if (requestsChartElem) {
        var requestsCtx = requestsChartElem.getContext('2d');
        new Chart(requestsCtx, {
            type: 'line',
            data: {
                labels: [{% for month in monthly_requests %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Requests',
                    data: [{% for month in monthly_requests %}{{ month.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Monthly Users Chart
    var usersChartElem = document.getElementById('usersChart');
    if (usersChartElem) {
        var usersCtx = usersChartElem.getContext('2d');
        new Chart(usersCtx, {
            type: 'line',
            data: {
                labels: [{% for month in monthly_users %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Users',
                    data: [{% for month in monthly_users %}{{ month.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Status Distribution Chart
    var statusChartElem = document.getElementById('statusChart');
    if (statusChartElem) {
        var statusCtx = statusChartElem.getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for status in status_distribution %}'{{ status.current_status|title }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for status in status_distribution %}{{ status.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        {% for status in status_distribution %}
                            {% if status.current_status == 'approved' %}'#10b981'{% elif status.current_status == 'rejected' %}'#ef4444'{% else %}'#e5e7eb'{% endif %}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // User Type Distribution Chart
    var userTypeChartElem = document.getElementById('userTypeChart');
    if (userTypeChartElem) {
        var userTypeCtx = userTypeChartElem.getContext('2d');
        // Create full thame mapping
        const userTypeNames = {
            'CRO': 'Chief Relation Officer',
            'PRO': 'Public Relation Officer',
            'CAO': 'Chief Academic Officer',
            'director': 'Director',
            'AC': 'Admin Coordinator',
            'AA': 'Assistant Administrator',
            'FO': 'Finance Officer',
            'Collage': 'College'
        };
        new Chart(userTypeCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for usertype in usertype_distribution %}'{{ usertype.usertype }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for usertype in usertype_distribution %}{{ usertype.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        '#667eea', // primary (custom gradient start)
                        '#764ba2', // secondary (custom gradient end)
                        '#06b6d4', // info
                        '#f59e0b', // warning
                        '#8b5cf6', // purple
                        '#64748b', // secondary
                        '#ef4444', // danger
                        '#14b8a6'  // teal
                    ],
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const shortName = context[0].label;
                                return userTypeNames[shortName] || shortName;
                            },
                            label: function(context) {
                                const shortName = context.label;
                                const fullName = userTypeNames[shortName] || shortName;
                                return fullName + ': ' + context.parsed + ' users';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var viewMoreBtn = document.getElementById('viewMoreStatusBtn');
    var showLessBtn = document.getElementById('showLessStatusBtn');
    var rows = document.querySelectorAll('.recent-status-row');
    if (viewMoreBtn && showLessBtn) {
        viewMoreBtn.addEventListener('click', function() {
            rows.forEach(function(row) {
                row.classList.remove('d-none');
            });
            viewMoreBtn.style.display = 'none';
            showLessBtn.classList.remove('d-none');
        });
        showLessBtn.addEventListener('click', function() {
            rows.forEach(function(row, idx) {
                if (idx >= 5) {
                    row.classList.add('d-none');
                }
            });
            viewMoreBtn.style.display = '';
            showLessBtn.classList.add('d-none');
            // Scroll to the table after hiding
            var table = document.getElementById('recentStatusChangesTable');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
});
</script>
{% endblock %}