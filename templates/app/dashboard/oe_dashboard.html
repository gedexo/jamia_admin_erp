{% load static %}

 <!-- Start::row-1 -->
 <div class="row">
    <div class="col-xxl-12 col-md-12 col-lg-12">
        
        <!-- Welcome Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card custom-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-custom-gradient rounded-circle shadow-gradient">
                                    <i class="fe fe-user fs-16 text-white"></i>
                                </span>
                            </div>
                            <div>
                                <h4 class="mb-1 text-gradient">Welcome back, {{ request.user.get_full_name|default:request.user.email }}!</h4>
                                <p class="mb-0 text-muted">Here's what's happening in your system today.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row">

            <h3 class=" mb-4">My Request Statistics</h3>

            <!-- My Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:my_request_submission_list' %}">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-primary-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-primary"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ my_requests_count }}</h4>
                                <p class="mb-0 text-muted">My Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary-transparent">{{ my_pending_requests }} pending</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- My Pending Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:my_request_submission_list' %}?status=pending">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-warning-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-warning"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ my_pending_requests_count }}</h4>
                                <p class="mb-0 text-muted">My Pending Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning-transparent">{{ my_pending_requests }} pending</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- My Approved Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:my_request_submission_list' %}?status=approved">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-success-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-success"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ my_approved_requests_count }}</h4>
                                <p class="mb-0 text-muted">My Approved Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success-transparent">{{ my_approved_requests }} approved</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- My Rejected Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:my_request_submission_list' %}?status=rejected">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-danger-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-danger"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ my_rejected_requests_count }}</h4>
                                <p class="mb-0 text-muted">My Rejected Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-danger-transparent">{{ my_rejected_requests }} rejected</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <div class="row">
            <h3 class="mb-4">Request Statistics</h3>

            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-info-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-info"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ total_requests }}</h4>
                                <p class="mb-0 text-muted">Total Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info-transparent">Total</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Assigned Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}?assigned=true">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-primary-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-primary"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ assigned_requests_count }}</h4>
                                <p class="mb-0 text-muted">Assigned Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary-transparent">{{ assigned_requests_count }} assigned</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Pending Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}?status=pending">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-warning-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-warning"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ pending_requests }}</h4>
                                <p class="mb-0 text-muted">Pending Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning-transparent">{{ pending_requests }} pending</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- re assign Requests -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <a href="{% url 'masters:request_submission_list' %}?status=re_assign">
                    <div class="card custom-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="me-3">
                                <span class="avatar avatar-lg bg-primary-transparent rounded-circle">
                                    <i class="fe fe-file-text fs-16 text-primary"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1 fw-semibold">{{ re_assigned_requests_count }}</h4>
                                <p class="mb-0 text-muted">Re Assigned Requests</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary-transparent">{{ re_assigned_requests_count }} assigned</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Assigned Requests Table -->
        <div class="row mb-4 m-0 p-0">
            <div class="col-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <h3 class="card-title">Assigned Requests</h3>
                        <div class="card-options">
                            <a href="{% url 'masters:request_submission_list' %}" class="btn btn-sm btn-primary gradient-hover">View All</a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in recent_assigned_requests %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm bg-light rounded-circle me-2">
                                                    <i class="fe fe-file-text fs-12"></i>
                                                </span>
                                                <div>
                                                    <h6 class="mb-0 fs-14">{{ request.title|truncatechars:30 }}</h6>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if request.dashboard_status == 'processing' %}
                                                <span class="badge bg-primary text-white">Processing</span>
                                            {% elif request.status == 're_assign' %}
                                                <span class="badge bg-dark bg-gradient text-white">Re Assigned</span>
                                            {% else %}
                                                <span class="badge bg-warning text-white">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ request.created|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <a href="{{ request.get_absolute_url }}" class="btn btn-sm btn-outline-primary">View</a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <div class="text-center">
                                                <i class="fe fe-file-text fs-48 text-muted mb-3"></i>
                                                <h6>No assigned requests</h6>
                                                <p class="text-muted">You have no requests assigned to you.</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


{% block javascript %}
<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Requests Chart
    var requestsChartElem = document.getElementById('requestsChart');
    if (requestsChartElem) {
        var requestsCtx = requestsChartElem.getContext('2d');
        new Chart(requestsCtx, {
            type: 'line',
            data: {
                labels: [{% for month in monthly_requests %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Requests',
                    data: [{% for month in monthly_requests %}{{ month.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Monthly Users Chart
    var usersChartElem = document.getElementById('usersChart');
    if (usersChartElem) {
        var usersCtx = usersChartElem.getContext('2d');
        new Chart(usersCtx, {
            type: 'line',
            data: {
                labels: [{% for month in monthly_users %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Users',
                    data: [{% for month in monthly_users %}{{ month.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Status Distribution Chart
    var statusChartElem = document.getElementById('statusChart');
    if (statusChartElem) {
        var statusCtx = statusChartElem.getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for status in status_distribution %}'{{ status.current_status|title }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for status in status_distribution %}{{ status.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        {% for status in status_distribution %}
                            {% if status.current_status == 'approved' %}'#10b981'{% elif status.current_status == 'rejected' %}'#ef4444'{% else %}'#e5e7eb'{% endif %}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // User Type Distribution Chart
    var userTypeChartElem = document.getElementById('userTypeChart');
    if (userTypeChartElem) {
        var userTypeCtx = userTypeChartElem.getContext('2d');
        // Create full thame mapping
        const userTypeNames = {
            'CRO': 'Chief Relation Officer',
            'PRO': 'Public Relation Officer',
            'CAO': 'Chief Academic Officer',
            'director': 'Director',
            'AC': 'Admin Coordinator',
            'AA': 'Assistant Administrator',
            'FO': 'Finance Officer',
            'Collage': 'College'
        };
        new Chart(userTypeCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for usertype in usertype_distribution %}'{{ usertype.usertype }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for usertype in usertype_distribution %}{{ usertype.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        '#667eea', // primary (custom gradient start)
                        '#764ba2', // secondary (custom gradient end)
                        '#06b6d4', // info
                        '#f59e0b', // warning
                        '#8b5cf6', // purple
                        '#64748b', // secondary
                        '#ef4444', // danger
                        '#14b8a6'  // teal
                    ],
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                const shortName = context[0].label;
                                return userTypeNames[shortName] || shortName;
                            },
                            label: function(context) {
                                const shortName = context.label;
                                const fullName = userTypeNames[shortName] || shortName;
                                return fullName + ': ' + context.parsed + ' users';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var viewMoreBtn = document.getElementById('viewMoreStatusBtn');
    var showLessBtn = document.getElementById('showLessStatusBtn');
    var rows = document.querySelectorAll('.recent-status-row');
    if (viewMoreBtn && showLessBtn) {
        viewMoreBtn.addEventListener('click', function() {
            rows.forEach(function(row) {
                row.classList.remove('d-none');
            });
            viewMoreBtn.style.display = 'none';
            showLessBtn.classList.remove('d-none');
        });
        showLessBtn.addEventListener('click', function() {
            rows.forEach(function(row, idx) {
                if (idx >= 5) {
                    row.classList.add('d-none');
                }
            });
            viewMoreBtn.style.display = '';
            showLessBtn.classList.add('d-none');
            // Scroll to the table after hiding
            var table = document.getElementById('recentStatusChangesTable');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
});
</script>
{% endblock %}